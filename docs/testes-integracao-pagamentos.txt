# Relatório de Testes - Integração de Pagamentos Maguinho

## Data do teste: 28/02/2025
## Testador: Iann

## Fluxo de Teste Realizado

1. **Login na plataforma**
   - Conta utilizada: iansingshau@gmail.com
   - Mensagem registrada: "Usuário não possui assinatura ativa"

2. **Navegação para assinatura**
   - Acesso à dashboard
   - Clique em "Ver planos"
   - Seleção de "Plano Básico Mensal"
   - Prosseguimento para pagamento

3. **Processo de checkout**
   - Botão "Pagar assinatura" do Mercado Pago criado corretamente
   - Comportamento: Redirecionamento para checkout externo do Mercado Pago (não manteve no site)
   - Informações no checkout:
     - Nome exibido: "MAGUINHO TEST"
     - Produto: "Plano Básico"
     - Valor: R$ 19,99

4. **Autenticação no Mercado Pago**
   - Conta de teste utilizada:
     - Usuário: TESTUSER1372776159
     - Senha: ptATFtPkK7

5. **Conclusão do pagamento**
   - Método: Saldo em conta (teste)
   - Resultado: Pagamento confirmado
   - Comportamento pós-pagamento: Redirecionamento para dashboard

## Logs e Registros

### Edge Function: create-payment-preference
```
"Preferência criada com sucesso: 2293113905-5d8e14a2-75f1-44e9-aab3-b55492781579"
"Cabeçalho de autorização: Bearer APP_USR-44..."
"Tentando criar preferência de pagamento com o Mercado Pago"
"Token de acesso obtido com sucesso"
"Tentando obter token de acesso com Client ID e Secret"
"Gerando novo token com Client ID e Client Secret"
"Client Secret disponível: true"
"Client ID disponível: true"
```

### Edge Function: payment-webhook
- **Resultado**: Nenhum log registrado!

### Mercado Pago
- Atividade registrada: "Venda de produtos" +R$ 19,99 às 10:17
- Referência da transação: 103704222347
- Cliente: Test Test (test_user_1372776159@testuser.com)
- Referência externa: 518d7220-f0e0-41ea-a699-e73fa1d605df

### Banco de Dados - Verificação de Tabelas

#### financial_logs
- Nenhum registro criado

#### payment_attempts
- 4 registros existentes, o mais recente:
```
"5859d367-6ce9-4acf-a974-c11413c7a0a5",
"518d7220-f0e0-41ea-a699-e73fa1d605df",
"2293113905-5d8e14a2-75f1-44e9-aab3-b55492781579",
"plano_basico_mensal",
"Plano Básico",
"19.99",
"mensal",
"pending",
"2025-02-28 10:12:53.944095",
"2025-02-28 10:12:53.944095"
```

#### payments
- Nenhum registro criado (deveria ter sido criado)

#### subscriptions
- Nenhum registro criado (deveria ter sido criado)

#### transactions
- Nenhum registro criado (deveria ter sido criado)

#### webhook_logs
- Nenhum registro criado

### Configuração de Webhook no Mercado Pago
- Status: 0% notificações entregues
- Problema identificado: URL configurada era de teste, não de produção

## Teste Adicional (28/02 - 11:18)

### Processo de Pagamento
- Realizado novo pagamento com saldo na conta de teste
- Operação #103710693812
- Status: Aprovado

### Mercado Pago Webhook
- Status: Falha na entrega
- Evento: payment.created
- Data/Hora: 28/02/2025, 14:18:49 (timezone diferente, horário local: 11:18)
- ID do pagamento: 103710693812

### Corpo da requisição enviada pelo MP:
```json
{
  "action": "payment.created",
  "api_version": "v1",
  "data": {
    "id": "103710693812"
  },
  "date_created": "2025-02-28T14:18:49Z",
  "id": 119435828889,
  "live_mode": true,
  "type": "payment",
  "user_id": "2293113905"
}
```

### Edge Function: payment-webhook
- Resultado: Nenhum log registrado novamente!

### Banco de Dados
- Nenhuma atualização nas tabelas payments, subscriptions

### Teste Direto da API
- Comando: 
```
Invoke-WebRequest -Uri "https://zssitwbdprfnqglttwhs.functions.supabase.co/payment-webhook" -Method POST -Body '{payload JSON}'
```
- Resultado: Erro 401 Não Autorizado
- Nenhum log na edge function

## Teste do Webhook Público (28/02/2025)

Recriamos a função de webhook com configuração `public_access: true` para evitar problemas de autenticação e reimplementamos a lógica de processamento para usar o campo `external_reference` ao invés de `preference_id`.

Modificamos também a função para usar diretamente os dados da notificação, em vez de fazer uma nova requisição à API do Mercado Pago para obter os detalhes do pagamento.

### Teste 1: Requisição direta com dados de teste

```powershell
Invoke-RestMethod -Uri "https://zssitwbdprfnqglttwhs.functions.supabase.co/payment-webhook-public" -Method POST -Body '{
  "action": "payment.created",
  "api_version": "v1",
  "data": {
    "id": "103710693812",
    "transaction_amount": 49.90,
    "status": "approved",
    "payment_method_id": "pix",
    "external_reference": "123456",
    "metadata": {
      "user_id": "123456",
      "plan_id": "2",
      "plan_interval": "mensal"
    }
  },
  "date_created": "2025-02-28T14:18:49Z",
  "id": 119435828889,
  "live_mode": true,
  "type": "payment",
  "user_id": "2293113905"
}' -ContentType "application/json"
```

Resultado: Erro 500 (Interno do Servidor).

### Próximos passos:

1. Verificar os logs da função no Supabase para identificar o erro específico
2. Corrigir a função com base nos erros encontrados
3. Atualizar a URL do webhook no Mercado Pago para apontar para a nova função pública
4. Realizar um teste completo de pagamento

## Problemas Identificados

1. **Webhook não está funcionando**
   - Causas prováveis:
     - Função edge requer autenticação (erro 401)
     - Configuração de segurança ou JWT incorreta
   - Impacto: Não está criando registros em payments, subscriptions e transactions

2. **Experiência de usuário no checkout**
   - Problema: Redirecionamento para site externo do Mercado Pago
   - Desejado: Manter o processo dentro da plataforma Maguinho

3. **Interface de pagamento**
   - Status: Necessita melhorias estéticas e de usabilidade

## Correções Realizadas (28/02/2025 - 11:46)

1. **Identificação do problema no webhook**:
   - A notificação enviada pelo Mercado Pago contém apenas o ID do pagamento sem metadados completos
   - A função estava tentando usar diretamente os dados da notificação em vez de buscar detalhes completos

2. **Modificações realizadas**:
   - Implementada lógica para buscar detalhes completos do pagamento na API do Mercado Pago usando o ID recebido na notificação
   - Ajustado o processamento dos dados para trabalhar com a estrutura retornada pela API
   - Melhorado o tratamento de erros e logs para facilitar diagnóstico futuro

3. **Estrutura da notificação real do Mercado Pago (exemplo)**:
```json
{
  "action": "payment.created",
  "api_version": "v1",
  "data": {
    "id": "103710693812"
  },
  "date_created": "2025-02-28T14:18:49Z",
  "id": 119435828889,
  "live_mode": true,
  "type": "payment",
  "user_id": "2293113905"
}
```

## Próximo Teste Planejado

1. Atualizar a URL do webhook no Mercado Pago para apontar para a função pública corrigida
2. Realizar um pagamento de teste completo
3. Verificar os logs da função para confirmar que está recebendo e processando corretamente a notificação
4. Verificar a criação dos registros nas tabelas:
   - payments
   - subscriptions
   - financial_logs
5. Confirmar que o status da assinatura do usuário está atualizado

## Próximos passos:

1. Verificar os logs da função no Supabase para identificar o erro específico
2. Corrigir a função com base nos erros encontrados
3. Atualizar a URL do webhook no Mercado Pago para apontar para a nova função pública
4. Realizar um teste completo de pagamento

## Ações Tomadas (28/02 - 14:40)

1. **Criado arquivo config.json para payment-webhook**
   - Configurado `public_access: true` para permitir acesso sem autenticação
   - Implantado através de `npx supabase functions deploy payment-webhook --no-verify-jwt`
   - Resultado: Erro 500 ao chamar a função diretamente

2. **Criado nova função payment-webhook-public**
   - Nova função criada com base no código existente
   - Configurado explicitamente `public_access: true` no config.json
   - Implantado com `--no-verify-jwt`
   - Resultado: Erro 500 ao chamar a função diretamente

3. **Testes realizados**
   - Ambas as funções ainda apresentam problemas
   - A função payment-webhook agora retorna erro 500 (Erro Interno) ao invés de erro 401 (Não Autorizado)
   - Indica progresso parcial, pois antes não era possível nem acessar a função

## Próximos Passos Atualizados

1. **Verificar logs de execução no Supabase**
   - Acessar o painel do Supabase para visualizar logs detalhados das funções edge
   - Identificar a causa específica do erro 500

2. **Testar função com dados simplificados**
   - Criar um payload mínimo para testar a função
   - Isolar possíveis erros no processamento do pagamento

3. **Verificar variáveis de ambiente**
   - Confirmar que todas as variáveis necessárias estão configuradas corretamente no Supabase
   - MP_CLIENT_ID, MP_CLIENT_SECRET, MP_WEBHOOK_SECRET, etc.

4. **Atualizar URL do webhook no Mercado Pago**
   - Atualizar para apontar para a função payment-webhook-public
   - Certificar-se de configurar para ambiente de produção
